<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自习神器 - 星空草原与成长雪人</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            overflow: hidden;
            background: linear-gradient(to bottom, #0a1a2d, #1a3a5f);
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #sky-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0a1a2d, #1a3a5f);
            z-index: 1;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 4s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30%;
            background: linear-gradient(to top, #2d5a2d, #3a6b3a);
            z-index: 2;
        }

        .grass {
            position: absolute;
            bottom: 30%;
            width: 100%;
            height: 10%;
            background: linear-gradient(to top, #3a6b3a, #4a7b4a);
            z-index: 3;
        }

        #snow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            pointer-events: none;
        }

        .snowflake {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            opacity: 0.8;
            top: -10px;
        }

        #main-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            transition: all 0.5s ease;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            color: #e6f7ff;
        }

        .btn {
            display: block;
            width: 200px;
            padding: 15px;
            margin: 15px auto;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            background: #3a7bc8;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .btn:active {
            transform: translateY(1px);
        }

        #time-options {
            display: none;
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .time-btn {
            display: inline-block;
            width: 80px;
            padding: 10px;
            margin: 5px;
            background: #5a9e6e;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-btn:hover {
            background: #4a8d5e;
            transform: scale(1.05);
        }

        #timer {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 3rem;
            z-index: 10;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 20px;
            border-radius: 15px;
            display: none;
        }

        #snowman-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            display: none;
            transition: transform 0.5s ease;
        }

        .snowman {
            position: relative;
            width: 150px;
            height: 200px;
            transform-origin: center bottom;
            transition: all 0.5s ease;
        }

        .snowball {
            position: absolute;
            background: white;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .snowball.bottom {
            width: 120px;
            height: 120px;
            bottom: 0;
            left: 15px;
        }

        .snowball.middle {
            width: 90px;
            height: 90px;
            bottom: 100px;
            left: 30px;
            z-index: 2;
        }

        .snowball.head {
            width: 70px;
            height: 70px;
            bottom: 170px;
            left: 40px;
            z-index: 3;
        }

        .snowman-hat {
            position: absolute;
            width: 80px;
            height: 20px;
            background: #333;
            bottom: 235px;
            left: 35px;
            z-index: 4;
            border-radius: 10px 10px 0 0;
        }

        .snowman-hat::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 40px;
            background: #333;
            bottom: 20px;
            left: 10px;
            border-radius: 5px 5px 0 0;
        }

        .snowman-eye {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #333;
            border-radius: 50%;
            z-index: 4;
        }

        .snowman-eye.left {
            bottom: 200px;
            left: 55px;
        }

        .snowman-eye.right {
            bottom: 200px;
            left: 85px;
        }

        .snowman-nose {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #ff8c42;
            bottom: 190px;
            left: 70px;
            z-index: 4;
            transform: rotate(45deg);
        }

        .snowman-button {
            position: absolute;
            width: 15px;
            height: 15px;
            background: #333;
            border-radius: 50%;
            z-index: 4;
        }

        .snowman-button:nth-child(1) {
            bottom: 150px;
            left: 67px;
        }

        .snowman-button:nth-child(2) {
            bottom: 130px;
            left: 67px;
        }

        .snowman-button:nth-child(3) {
            bottom: 110px;
            left: 67px;
        }

        #sound-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            border-radius: 15px;
            z-index: 10;
            display: none;
        }

        #sound-level {
            width: 150px;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        #sound-fill {
            height: 100%;
            background: #4a90e2;
            width: 0%;
            transition: width 0.3s ease;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        .fade-out {
            animation: fadeOut 0.5s ease forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        #instructions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            border-radius: 15px;
            z-index: 10;
            display: none;
            max-width: 250px;
            font-size: 0.9rem;
        }
        
        #size-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            border-radius: 15px;
            z-index: 10;
            display: none;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sky-bg">
            <!-- 星星将通过JS动态生成 -->
        </div>
        
        <div class="ground"></div>
        <div class="grass"></div>
        
        <div id="snow-container"></div>
        
        <div id="main-menu">
            <h1>自习神器</h1>
            <button id="start-btn" class="btn">开始自习</button>
            <button id="time-btn" class="btn">设置时间</button>
            
            <div id="time-options">
                <button class="time-btn" data-time="10">10分钟</button>
                <button class="time-btn" data-time="30">30分钟</button>
                <button class="time-btn" data-time="45">45分钟</button>
                <button class="time-btn" data-time="60">60分钟</button>
            </div>
        </div>
        
        <div id="timer">00:00</div>
        <div id="size-indicator">雪人尺寸: 1.0x</div>
        
        <div id="snowman-container">
            <div class="snowman">
                <div class="snowball bottom"></div>
                <div class="snowball middle"></div>
                <div class="snowball head"></div>
                <div class="snowman-hat"></div>
                <div class="snowman-eye left"></div>
                <div class="snowman-eye right"></div>
                <div class="snowman-nose"></div>
                <div class="snowman-button"></div>
                <div class="snowman-button"></div>
                <div class="snowman-button"></div>
            </div>
        </div>
        
        <div id="sound-indicator">
            <div>环境音量</div>
            <div id="sound-level">
                <div id="sound-fill"></div>
            </div>
        </div>
        
        <div id="instructions">
            <p>保持安静，雪人会长得更大！</p>
            <p>环境越安静，雪人成长越快，雪下得越大。</p>
        </div>
    </div>

    <script>
        // 应用状态
        const state = {
            selectedTime: 25, // 默认时间（分钟）
            isStudying: false,
            snowmanSize: 0.5, // 雪人初始大小 (缩小一倍)
            snowIntensity: 50, // 雪花强度 (0-100)
            snowflakes: [],
            audioContext: null,
            analyser: null,
            microphone: null,
            dataArray: null,
            timerInterval: null,
            growthInterval: null,
            totalTime: 0,
            elapsedTime: 0,
            snowflakeInterval: null,
            maxSize: 5.0, // 最大尺寸为初始雪人的5倍
            normalSize: 3.0 // 正常情况下成长为初始的3倍
        };

        // DOM元素
        const elements = {
            mainMenu: document.getElementById('main-menu'),
            startBtn: document.getElementById('start-btn'),
            timeBtn: document.getElementById('time-btn'),
            timeOptions: document.getElementById('time-options'),
            timer: document.getElementById('timer'),
            sizeIndicator: document.getElementById('size-indicator'),
            snowmanContainer: document.getElementById('snowman-container'),
            snowman: document.querySelector('.snowman'),
            soundIndicator: document.getElementById('sound-indicator'),
            soundFill: document.getElementById('sound-fill'),
            instructions: document.getElementById('instructions'),
            skyBg: document.getElementById('sky-bg'),
            snowContainer: document.getElementById('snow-container')
        };

        // 初始化事件监听
        function initEventListeners() {
            elements.startBtn.addEventListener('click', startStudy);
            elements.timeBtn.addEventListener('click', toggleTimeOptions);
            
            // 时间选项按钮
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    state.selectedTime = parseInt(this.getAttribute('data-time'));
                    elements.timeOptions.style.display = 'none';
                    elements.startBtn.textContent = `开始 ${state.selectedTime} 分钟自习`;
                });
            });
        }

        // 创建星空背景
        function createStars() {
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // 随机大小
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                // 随机位置
                const x = Math.random() * 100;
                const y = Math.random() * 80; // 只在上部80%区域生成星星
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                
                // 随机闪烁延迟
                star.style.animationDelay = `${Math.random() * 4}s`;
                
                elements.skyBg.appendChild(star);
            }
        }

        // 切换时间选项显示
        function toggleTimeOptions() {
            if (elements.timeOptions.style.display === 'block') {
                elements.timeOptions.style.display = 'none';
            } else {
                elements.timeOptions.style.display = 'block';
            }
        }

        // 开始自习
        function startStudy() {
            if (state.isStudying) return;
            
            state.isStudying = true;
            state.totalTime = state.selectedTime * 60; // 转换为秒
            state.elapsedTime = 0;
            state.snowmanSize = 0.5; // 初始大小缩小一倍
            
            // 隐藏主菜单
            elements.mainMenu.classList.add('fade-out');
            setTimeout(() => {
                elements.mainMenu.style.display = 'none';
            }, 500);
            
            // 显示计时器、声音指示器、尺寸指示器和说明
            elements.timer.style.display = 'block';
            elements.soundIndicator.style.display = 'block';
            elements.sizeIndicator.style.display = 'block';
            elements.instructions.style.display = 'block';
            
            // 显示雪人
            elements.snowmanContainer.style.display = 'block';
            updateSnowmanSize();
            
            // 开始下雪
            createSnowflakes();
            
            // 开始倒计时
            startTimer();
            
            // 开始声音检测
            initAudioDetection();
            
            // 开始雪人成长动画 (每2秒成长一次)
            startSnowmanGrowth();
        }

        // 开始倒计时
        function startTimer() {
            let timer = state.totalTime;
            const timerElement = elements.timer;
            
            state.timerInterval = setInterval(() => {
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                state.elapsedTime = state.totalTime - timer;
                
                if (--timer < 0) {
                    clearInterval(state.timerInterval);
                    timerElement.textContent = "时间到!";
                    endStudy();
                }
            }, 1000);
        }

        // 创建雪花
        function createSnowflakes() {
            // 初始创建一些雪花
            for (let i = 0; i < 50; i++) {
                createSnowflake();
            }
            
            // 定期创建新雪花
            state.snowflakeInterval = setInterval(() => {
                // 根据雪花强度决定创建多少新雪花
                const newFlakes = Math.floor(state.snowIntensity / 20);
                for (let i = 0; i < newFlakes; i++) {
                    if (state.snowflakes.length < 200) { // 限制最大雪花数量
                        createSnowflake();
                    }
                }
            }, 500);
        }

        // 创建单个雪花
        function createSnowflake() {
            const snowflake = document.createElement('div');
            snowflake.classList.add('snowflake');
            
            // 随机大小 (基于雪花强度)
            const size = Math.random() * 5 + 2 + (state.snowIntensity / 25);
            snowflake.style.width = `${size}px`;
            snowflake.style.height = `${size}px`;
            
            // 随机位置
            const startX = Math.random() * window.innerWidth;
            snowflake.style.left = `${startX}px`;
            
            // 随机透明度 (基于雪花强度)
            const opacity = Math.random() * 0.5 + 0.3 + (state.snowIntensity / 200);
            snowflake.style.opacity = opacity.toString();
            
            // 随机下落速度 (基于雪花强度)
            const fallSpeed = Math.random() * 3 + 2 + (state.snowIntensity / 25);
            
            // 随机摇摆幅度
            const swayRange = Math.random() * 50 + 20;
            
            elements.snowContainer.appendChild(snowflake);
            
            // 存储雪花数据
            const snowflakeData = {
                element: snowflake,
                x: startX,
                y: -10,
                speed: fallSpeed,
                sway: swayRange,
                swaySpeed: Math.random() * 0.02 + 0.01,
                swayOffset: Math.random() * Math.PI * 2
            };
            
            state.snowflakes.push(snowflakeData);
            
            // 开始动画
            animateSnowflake(snowflakeData);
        }

        // 雪花动画
        function animateSnowflake(snowflake) {
            function update() {
                // 更新位置
                snowflake.y += snowflake.speed;
                snowflake.x += Math.sin(Date.now() * snowflake.swaySpeed + snowflake.swayOffset) * (snowflake.sway / 100);
                
                // 应用新位置
                snowflake.element.style.top = `${snowflake.y}px`;
                snowflake.element.style.left = `${snowflake.x}px`;
                
                // 如果雪花超出屏幕，重置位置
                if (snowflake.y > window.innerHeight) {
                    snowflake.y = -10;
                    snowflake.x = Math.random() * window.innerWidth;
                }
                
                // 如果雪花超出水平边界，重置位置
                if (snowflake.x < -10 || snowflake.x > window.innerWidth + 10) {
                    snowflake.y = -10;
                    snowflake.x = Math.random() * window.innerWidth;
                }
                
                // 继续动画
                if (state.isStudying) {
                    requestAnimationFrame(update);
                }
            }
            
            update();
        }

        // 更新雪花强度
        function updateSnowIntensity() {
            // 更新现有雪花的速度和大小
            state.snowflakes.forEach(snowflake => {
                // 根据强度调整速度
                const baseSpeed = 2;
                snowflake.speed = baseSpeed + (state.snowIntensity / 25);
                
                // 根据强度调整大小
                const size = Math.random() * 5 + 2 + (state.snowIntensity / 25);
                snowflake.element.style.width = `${size}px`;
                snowflake.element.style.height = `${size}px`;
                
                // 根据强度调整透明度
                const opacity = Math.random() * 0.5 + 0.3 + (state.snowIntensity / 200);
                snowflake.element.style.opacity = opacity.toString();
            });
        }

        // 初始化音频检测
        function initAudioDetection() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("您的浏览器不支持音频检测功能，但您仍然可以使用自习计时器。");
                return;
            }
            
            // 请求麦克风权限
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    // 创建音频上下文
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    state.analyser = state.audioContext.createAnalyser();
                    state.microphone = state.audioContext.createMediaStreamSource(stream);
                    
                    // 连接分析器
                    state.microphone.connect(state.analyser);
                    state.analyser.fftSize = 256;
                    
                    // 创建数据数组
                    const bufferLength = state.analyser.frequencyBinCount;
                    state.dataArray = new Uint8Array(bufferLength);
                    
                    // 开始分析音频
                    analyzeAudio();
                })
                .catch(err => {
                    console.error("无法访问麦克风:", err);
                    alert("无法访问麦克风，但您仍然可以使用自习计时器。");
                });
        }

        // 分析音频
        function analyzeAudio() {
            if (!state.analyser || !state.dataArray) return;
            
            // 获取音频数据
            state.analyser.getByteFrequencyData(state.dataArray);
            
            // 计算平均音量
            let sum = 0;
            for (let i = 0; i < state.dataArray.length; i++) {
                sum += state.dataArray[i];
            }
            const average = sum / state.dataArray.length;
            
            // 更新雪花强度 (声音越小，雪花越大越多)
            // 将音量映射到雪花强度 (0-100)
            state.snowIntensity = Math.max(10, 100 - average);
            
            // 更新声音指示器
            elements.soundFill.style.width = `${Math.min(100, average)}%`;
            
            // 更新雪花效果
            updateSnowIntensity();
            
            // 继续分析
            if (state.isStudying) {
                requestAnimationFrame(analyzeAudio);
            }
        }

        // 开始雪人成长动画
        function startSnowmanGrowth() {
            // 每2秒成长一次
            state.growthInterval = setInterval(() => {
                if (!state.isStudying) return;
                
                // 计算进度百分比
                const progress = state.elapsedTime / state.totalTime;
                
                // 获取当前音量数据
                let currentVolume = 50; // 默认值
                if (state.dataArray) {
                    let sum = 0;
                    for (let i = 0; i < state.dataArray.length; i++) {
                        sum += state.dataArray[i];
                    }
                    currentVolume = sum / state.dataArray.length;
                }
                
                // 根据音量调整成长速度
                // 音量越小，成长速度越快
                const volumeFactor = Math.max(0.1, 1 - (currentVolume / 100));
                
                // 计算每次成长的大小增量
                // 目标是在正常情况下成长为初始的3倍
                const baseGrowth = (state.normalSize - 0.5) / (state.totalTime / 2);
                const growthIncrement = baseGrowth * volumeFactor;
                
                // 更新雪人大小，但不超过最大尺寸
                state.snowmanSize = Math.min(state.maxSize, state.snowmanSize + growthIncrement);
                
                // 更新雪人大小
                updateSnowmanSize();
            }, 2000); // 每2秒执行一次
        }

        // 更新雪人大小
        function updateSnowmanSize() {
            elements.snowman.style.transform = `scale(${state.snowmanSize})`;
            elements.sizeIndicator.textContent = `雪人尺寸: ${state.snowmanSize.toFixed(1)}x`;
        }

        // 结束自习
        function endStudy() {
            state.isStudying = false;
            
            // 停止雪花生成
            if (state.snowflakeInterval) {
                clearInterval(state.snowflakeInterval);
            }
            
            // 停止雪人成长
            if (state.growthInterval) {
                clearInterval(state.growthInterval);
            }
            
            // 显示完成消息
            setTimeout(() => {
                alert(`自习完成！\n您的雪人最终尺寸: ${state.snowmanSize.toFixed(1)}倍`);
                
                // 重置界面
                resetInterface();
            }, 1000);
        }

        // 重置界面
        function resetInterface() {
            // 显示主菜单
            elements.mainMenu.style.display = 'block';
            elements.mainMenu.classList.remove('fade-out');
            
            // 隐藏其他元素
            elements.timer.style.display = 'none';
            elements.soundIndicator.style.display = 'none';
            elements.sizeIndicator.style.display = 'none';
            elements.instructions.style.display = 'none';
            elements.snowmanContainer.style.display = 'none';
            
            // 清除雪花
            state.snowflakes.forEach(snowflake => {
                if (snowflake.element.parentNode) {
                    snowflake.element.parentNode.removeChild(snowflake.element);
                }
            });
            state.snowflakes = [];
            
            // 重置雪人大小
            state.snowmanSize = 0.5;
            updateSnowmanSize();
            
            // 停止音频分析
            if (state.audioContext) {
                state.audioContext.close();
                state.audioContext = null;
            }
            
            // 清除计时器
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }

        // 初始化应用
        function initApp() {
            createStars();
            initEventListeners();
        }

        // 当页面加载完成时初始化应用
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>